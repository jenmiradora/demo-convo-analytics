<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Audit Dashboard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for creating charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom font and basic body styling */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8 md:p-12">
    <div class="max-w-6xl mx-auto">
        <!-- Dashboard Header and Clear Filters Button -->
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-800 leading-tight">Interactive Audit Performance Dashboard</h1>
            <p class="text-gray-500 mt-2">Click on a chart to filter the data.</p>
            <button id="clearFiltersBtn" class="mt-4 px-4 py-2 bg-indigo-500 text-white font-semibold rounded-full shadow-md hover:bg-indigo-600 transition-colors">
                Clear Filters
            </button>
        </header>

        <!-- Main Dashboard Grid with individual sentiment cards -->
        <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Audits Card -->
            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
                <div class="text-sm font-semibold text-gray-500 mb-2">Total Audits</div>
                <div id="totalAudits" class="text-4xl font-bold text-indigo-600"></div>
            </div>

            <!-- Overall Score Card -->
            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
                <div class="text-sm font-semibold text-gray-500 mb-2">Average Score</div>
                <div id="auditScore" class="text-4xl font-bold text-green-600"></div>
            </div>

            <!-- Positive Sentiment Card -->
            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
                <div class="text-sm font-semibold text-gray-500 mb-2">Positive Sentiment</div>
                <div id="positiveCount" class="text-4xl font-bold text-green-500"></div>
            </div>

            <!-- Neutral Sentiment Card -->
            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
                <div class="text-sm font-semibold text-gray-500 mb-2">Neutral Sentiment</div>
                <div id="neutralCount" class="text-4xl font-bold text-yellow-500"></div>
            </div>

            <!-- Negative Sentiment Card -->
            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
                <div class="text-sm font-semibold text-gray-500 mb-2">Negative Sentiment</div>
                <div id="negativeCount" class="text-4xl font-bold text-red-500"></div>
            </div>
        </main>

        <!-- Time-Series Analysis Chart Section -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Time-Series Analysis</h2>
            <div class="relative h-96">
                <canvas id="auditsScoresChart"></canvas>
            </div>
        </section>

        <!-- Two-column section for Issues and Agents -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Customer Issues Section -->
            <section class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Top Customer Issues</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Issue
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Count
                                </th>
                            </tr>
                        </thead>
                        <tbody id="issuesTable" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Agents Breakdown Section -->
            <section class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Agents Breakdown</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Agent Name
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Audits
                                </th>
                            </tr>
                        </thead>
                        <tbody id="agentsTable" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- Bivariate Analysis Charts Section -->
        <section class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Bivariate Analysis</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- QA Scores vs. Sentiment -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-700 text-center mb-4">QA Scores vs. Sentiment</h3>
                    <div class="relative h-64">
                        <canvas id="qaSentimentChart"></canvas>
                    </div>
                </div>

                <!-- Customer Issues vs. Sentiment -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-700 text-center mb-4">Customer Issues vs. Sentiment</h3>
                    <div class="relative h-64">
                        <canvas id="issuesSentimentChart"></canvas>
                    </div>
                </div>

                <!-- QA Scores vs. Customer Issues -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-700 text-center mb-4">QA Scores vs. Customer Issues</h3>
                    <div class="relative h-64">
                        <canvas id="qaIssuesChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- JavaScript for populating the dashboard with data and charts -->
    <script>
        let myAuditsScoresChart, myQaSentimentChart, myIssuesSentimentChart, myQaIssuesChart;
        let allAudits = [];

        // --- MOCK DATA ---
        // Generates sample data with consistent totals and properties.
        function generateMockData() {
            const issues = ['Billing Discrepancy', 'Login Errors', 'Service Outage', 'Slow Performance', 'Feature Request'];
            const agents = ['John Doe', 'Jane Smith', 'Peter Jones', 'Mary Brown', 'David Lee'];
            const sentiments = ['Positive', 'Neutral', 'Negative'];
            const dates = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5'];
            const totalAuditsToGenerate = 1542;
            let generatedData = [];

            for (let i = 0; i < totalAuditsToGenerate; i++) {
                const randomIssue = issues[Math.floor(Math.random() * issues.length)];
                const randomAgent = agents[Math.floor(Math.random() * agents.length)];
                const randomSentiment = sentiments[Math.floor(Math.random() * sentiments.length)];
                const randomDate = dates[Math.floor(Math.random() * dates.length)];
                const randomScore = Math.floor(Math.random() * 50) + 50; // Score between 50 and 100

                generatedData.push({
                    date: randomDate,
                    sentiment: randomSentiment,
                    score: randomScore,
                    issue: randomIssue,
                    agent: randomAgent
                });
            }
            return generatedData;
        }

        // --- Main Dashboard Update Function ---
        function updateDashboard(filteredAudits = allAudits) {
            // Destroy existing charts to prevent duplication
            if (myAuditsScoresChart) myAuditsScoresChart.destroy();
            if (myQaSentimentChart) myQaSentimentChart.destroy();
            if (myIssuesSentimentChart) myIssuesSentimentChart.destroy();
            if (myQaIssuesChart) myQaIssuesChart.destroy();

            // Aggregate data from the filtered set
            const totalAudits = filteredAudits.length;
            const avgScore = totalAudits > 0 ? (filteredAudits.reduce((sum, audit) => sum + audit.score, 0) / totalAudits) : 0;
            const sentimentCounts = filteredAudits.reduce((acc, audit) => {
                acc[audit.sentiment] = (acc[audit.sentiment] || 0) + 1;
                return acc;
            }, { 'Positive': 0, 'Neutral': 0, 'Negative': 0 });
            
            const issuesData = filteredAudits.reduce((acc, audit) => {
                acc[audit.issue] = (acc[audit.issue] || 0) + 1;
                return acc;
            }, {});
            const sortedIssues = Object.keys(issuesData).map(key => ({ name: key, count: issuesData[key] })).sort((a, b) => b.count - a.count);

            const agentsData = filteredAudits.reduce((acc, audit) => {
                acc[audit.agent] = (acc[audit.agent] || 0) + 1;
                return acc;
            }, {});
            const sortedAgents = Object.keys(agentsData).map(key => ({ name: key, audits: agentsData[key] })).sort((a, b) => b.audits - a.audits);

            // Time-series data
            const timeSeriesData = filteredAudits.reduce((acc, audit) => {
                acc[audit.date] = acc[audit.date] || { count: 0, scoreSum: 0 };
                acc[audit.date].count++;
                acc[audit.date].scoreSum += audit.score;
                return acc;
            }, {});
            const dates = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5'];
            const timeSeriesAuditCount = dates.map(date => timeSeriesData[date] ? timeSeriesData[date].count : 0);
            const timeSeriesAvgScore = dates.map(date => timeSeriesData[date] ? timeSeriesData[date].scoreSum / timeSeriesData[date].count : 0);
            
            // Bivariate chart data
            const qaSentimentScores = {
                'Positive': filteredAudits.filter(a => a.sentiment === 'Positive').map(a => a.score),
                'Neutral': filteredAudits.filter(a => a.sentiment === 'Neutral').map(a => a.score),
                'Negative': filteredAudits.filter(a => a.sentiment === 'Negative').map(a => a.score)
            };
            const avgQaSentimentScores = Object.keys(qaSentimentScores).map(key => {
                const scores = qaSentimentScores[key];
                return scores.length > 0 ? (scores.reduce((sum, s) => sum + s, 0) / scores.length).toFixed(1) : 0;
            });
            
            // --- Update DOM Elements ---
            document.getElementById('totalAudits').textContent = totalAudits.toLocaleString();
            document.getElementById('auditScore').textContent = `${avgScore.toFixed(1)}%`;
            document.getElementById('positiveCount').textContent = sentimentCounts.Positive;
            document.getElementById('neutralCount').textContent = sentimentCounts.Neutral;
            document.getElementById('negativeCount').textContent = sentimentCounts.Negative;

            // Populate Issues Table
            const issuesTableBody = document.getElementById('issuesTable');
            issuesTableBody.innerHTML = '';
            sortedIssues.slice(0, 5).forEach(issue => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${issue.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${issue.count}</td>
                `;
                issuesTableBody.appendChild(row);
            });
            
            // Populate Agents Table
            const agentsTableBody = document.getElementById('agentsTable');
            agentsTableBody.innerHTML = '';
            sortedAgents.slice(0, 5).forEach(agent => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${agent.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${agent.audits}</td>
                `;
                agentsTableBody.appendChild(row);
            });

            // --- Recreate Charts with new data ---
            // Audits & Average Score Over Time - Bar/Line Combo Chart
            myAuditsScoresChart = new Chart(document.getElementById('auditsScoresChart'), {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        type: 'bar',
                        label: 'Audits',
                        data: timeSeriesAuditCount,
                        backgroundColor: '#6366F1', // Indigo
                        yAxisID: 'y'
                    }, {
                        type: 'line',
                        label: 'Average Score',
                        data: timeSeriesAvgScore,
                        borderColor: '#10B981', // Green
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderWidth: 2,
                        yAxisID: 'y1',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Audits'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Average Score (%)'
                            }
                        }
                    },
                    onClick: (evt, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const label = dates[index];
                            filterDashboard('date', label);
                        }
                    }
                }
            });

            // QA Scores vs. Sentiment - Bar Chart
            myQaSentimentChart = new Chart(document.getElementById('qaSentimentChart'), {
                type: 'bar',
                data: {
                    labels: ['Positive', 'Neutral', 'Negative'],
                    datasets: [{
                        label: 'Average QA Score',
                        data: avgQaSentimentScores,
                        backgroundColor: ['#10B981', '#F59E0B', '#EF4444'], // Green, Yellow, Red
                        borderColor: ['#047857', '#B45309', '#B91C1C'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'QA Score (%)'
                            }
                        }
                    },
                    onClick: (evt, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const label = ['Positive', 'Neutral', 'Negative'][index];
                            filterDashboard('sentiment', label);
                        }
                    }
                }
            });

            // Customer Issues vs. Sentiment - Pie Chart (shows proportion)
            myIssuesSentimentChart = new Chart(document.getElementById('issuesSentimentChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Neutral', 'Negative'],
                    datasets: [{
                        label: 'Issue Count',
                        data: [sentimentCounts.Positive, sentimentCounts.Neutral, sentimentCounts.Negative],
                        backgroundColor: ['#10B981', '#F59E0B', '#EF4444'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.raw !== null) {
                                        label += context.raw.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    onClick: (evt, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const label = ['Positive', 'Neutral', 'Negative'][index];
                            filterDashboard('sentiment', label);
                        }
                    }
                }
            });

            // QA Scores vs. Customer Issues - Line/Bar Combo Chart
            myQaIssuesChart = new Chart(document.getElementById('qaIssuesChart'), {
                type: 'line', // Use line for scores to show trend
                data: {
                    labels: sortedIssues.map(i => i.name).slice(0, 5),
                    datasets: [{
                        type: 'bar',
                        label: 'Customer Issues',
                        data: sortedIssues.map(i => i.count).slice(0, 5),
                        backgroundColor: '#F97316',
                        yAxisID: 'y1'
                    },
                    {
                        type: 'line',
                        label: 'QA Score',
                        data: sortedIssues.map(i => i.count * 1.5).slice(0, 5), // Placeholder
                        borderColor: '#2563EB',
                        backgroundColor: 'rgba(37, 99, 235, 0.2)',
                        yAxisID: 'y',
                        tension: 0.4,
                        fill: false
                    }
                ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: false,
                            min: 70, // Start y-axis higher for better visibility
                            title: {
                                display: true,
                                text: 'QA Score'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false, // Only draw the grid for the left axis
                            },
                            title: {
                                display: true,
                                text: 'Issue Count'
                            }
                        }
                    },
                    onClick: (evt, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const label = sortedIssues.map(i => i.name)[index];
                            filterDashboard('issue', label);
                        }
                    }
                }
            });
        }
        
        // --- Filtering Logic ---
        function filterDashboard(filterType, filterValue) {
            const filteredData = allAudits.filter(audit => audit[filterType] === filterValue);
            updateDashboard(filteredData);
        }

        function resetFilters() {
            updateDashboard(allAudits);
        }

        // Run the function when the page loads
        window.onload = () => {
            allAudits = generateMockData();
            updateDashboard();
            document.getElementById('clearFiltersBtn').addEventListener('click', resetFilters);
        };
    </script>
</body>
</html>
